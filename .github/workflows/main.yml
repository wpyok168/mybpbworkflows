name: Auto Update Worker

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *" # æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      update_latest:
        description: 'æ˜¯å¦æ‰‹åŠ¨æ›´æ–° Latest æ­£å¼ç‰ˆï¼Ÿ'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: åˆå§‹åŒ–ä»“åº“
        uses: actions/checkout@v4

      - name: è·å–å½“å‰æœ¬åœ°ç‰ˆæœ¬
        id: local_version
        run: |
          if [ -f version.txt ]; then
            LOCAL_VERSION=$(cat version.txt)
            echo "LOCAL_VERSION=$LOCAL_VERSION" >> $GITHUB_ENV
          else
            echo "LOCAL_VERSION=v0.0.0" >> $GITHUB_ENV
          fi
          echo "å½“å‰æœ¬åœ°ç‰ˆæœ¬: $LOCAL_VERSION"

      - name: è·å–æ‰€æœ‰å‘å¸ƒç‰ˆæœ¬ä¿¡æ¯
        id: get_releases
        run: |
          API_URL="https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases"
          RESPONSE=$(curl -s "$API_URL")
          
          # è°ƒè¯•è¾“å‡º
          echo "APIå“åº”:"
          echo "$RESPONSE" | jq .[] | head -20
          
          # è·å–æœ€æ–°æ­£å¼ç‰ˆ
          LATEST_RELEASE=$(echo "$RESPONSE" | jq -r '[.[] | select(.prerelease==false)][0] // "null"')
          if [ "$LATEST_RELEASE" != "null" ]; then
            LATEST_TAG=$(echo "$LATEST_RELEASE" | jq -r '.tag_name // ""')
            LATEST_DOWNLOAD=$(echo "$LATEST_RELEASE" | jq -r '.assets[]? | select(.name=="worker.zip") | .browser_download_url // ""')
          else
            LATEST_TAG=""
            LATEST_DOWNLOAD=""
          fi
          
          # è·å–æœ€æ–°Pre-release
          PRE_RELEASE=$(echo "$RESPONSE" | jq -r '[.[] | select(.prerelease==true)][0] // "null"')
          if [ "$PRE_RELEASE" != "null" ]; then
            PRE_TAG=$(echo "$PRE_RELEASE" | jq -r '.tag_name // ""')
            PRE_DOWNLOAD=$(echo "$PRE_RELEASE" | jq -r '.assets[]? | select(.name=="worker.zip") | .browser_download_url // ""')
          else
            PRE_TAG=""
            PRE_DOWNLOAD=""
          fi
          
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "LATEST_DOWNLOAD=$LATEST_DOWNLOAD" >> $GITHUB_ENV
          echo "PRE_TAG=$PRE_TAG" >> $GITHUB_ENV
          echo "PRE_DOWNLOAD=$PRE_DOWNLOAD" >> $GITHUB_ENV
          
          echo "æœ€æ–°æ­£å¼ç‰ˆ: $LATEST_TAG"
          echo "æœ€æ–°Pre-release: $PRE_TAG"

      - name: ç‰ˆæœ¬æ¯”è¾ƒå’Œé€‰æ‹©æ›´æ–°ç›®æ ‡
        id: select_target
        run: |
          # ç®€åŒ–ç‰ˆæœ¬æ¯”è¾ƒå‡½æ•°
          compare_versions() {
            if [ "$1" = "$2" ]; then
              return 0
            fi
            
            # ä½¿ç”¨sortè¿›è¡Œç‰ˆæœ¬æ¯”è¾ƒ
            higher_version=$(echo -e "$1\n$2" | sed 's/^v//' | sort -V -r | head -n1 | sed 's/^/v/')
            if [ "$1" = "$higher_version" ]; then
              return 1
            else
              return 2
            fi
          }
          
          # åˆå§‹åŒ–å˜é‡
          TARGET_TAG=""
          TARGET_DOWNLOAD=""
          UPDATE_REASON=""
          UPDATE_NEEDED="false"
          
          echo "æ¯”è¾ƒç‰ˆæœ¬..."
          echo "æœ¬åœ°ç‰ˆæœ¬: $LOCAL_VERSION"
          echo "æœ€æ–°æ­£å¼ç‰ˆ: $LATEST_TAG"
          echo "æœ€æ–°Pre-release: $PRE_TAG"
          
          # æ‰‹åŠ¨æ›´æ–°Latestçš„æƒ…å†µ
          if [ "${{ github.event.inputs.update_latest }}" = "true" ] && [ -n "$LATEST_TAG" ]; then
            TARGET_TAG="$LATEST_TAG"
            TARGET_DOWNLOAD="$LATEST_DOWNLOAD"
            UPDATE_REASON="manual_latest"
            UPDATE_NEEDED="true"
            echo "æ‰‹åŠ¨é€‰æ‹©æ›´æ–°åˆ° Latest: $LATEST_TAG"
          
          # è‡ªåŠ¨æ›´æ–°é€»è¾‘
          else
            # æ£€æŸ¥æœ€æ–°æ­£å¼ç‰ˆ
            if [ -n "$LATEST_TAG" ] && [ "$LOCAL_VERSION" != "$LATEST_TAG" ]; then
              compare_versions "$LOCAL_VERSION" "$LATEST_TAG"
              result=$?
              if [ $result -eq 2 ]; then
                TARGET_TAG="$LATEST_TAG"
                TARGET_DOWNLOAD="$LATEST_DOWNLOAD"
                UPDATE_REASON="newer_latest"
                UPDATE_NEEDED="true"
                echo "å‘ç°æ›´æ–°çš„æ­£å¼ç‰ˆ: $LATEST_TAG"
              fi
            fi
            
            # å¦‚æœæ²¡æœ‰æ­£å¼ç‰ˆæ›´æ–°ï¼Œæ£€æŸ¥Pre-release
            if [ "$UPDATE_NEEDED" = "false" ] && [ -n "$PRE_TAG" ] && [ "$LOCAL_VERSION" != "$PRE_TAG" ]; then
              compare_versions "$LOCAL_VERSION" "$PRE_TAG"
              result=$?
              if [ $result -eq 2 ]; then
                TARGET_TAG="$PRE_TAG"
                TARGET_DOWNLOAD="$PRE_DOWNLOAD"
                UPDATE_REASON="newer_pre"
                UPDATE_NEEDED="true"
                echo "å‘ç°æ›´æ–°çš„Pre-release: $PRE_TAG"
              fi
            fi
          fi
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "TARGET_TAG=$TARGET_TAG" >> $GITHUB_ENV
          echo "TARGET_DOWNLOAD=$TARGET_DOWNLOAD" >> $GITHUB_ENV
          echo "UPDATE_REASON=$UPDATE_REASON" >> $GITHUB_ENV
          echo "UPDATE_NEEDED=$UPDATE_NEEDED" >> $GITHUB_ENV
          
          if [ "$UPDATE_NEEDED" = "true" ]; then
            echo "éœ€è¦æ›´æ–°åˆ°: $TARGET_TAG"
          else
            echo "å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
          fi

      - name: æ‰§è¡Œæ›´æ–°
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "å¼€å§‹æ›´æ–°åˆ°ç‰ˆæœ¬: $TARGET_TAG"
          echo "ä¸‹è½½é“¾æ¥: $TARGET_DOWNLOAD"
          
          # æ£€æŸ¥ä¸‹è½½é“¾æ¥æ˜¯å¦æœ‰æ•ˆ
          if [ -z "$TARGET_DOWNLOAD" ]; then
            echo "é”™è¯¯: ä¸‹è½½é“¾æ¥ä¸ºç©º"
            exit 1
          fi
          
          # æ¸…ç†å½“å‰ç›®å½•ï¼ˆä¿ç•™.gitï¼‰
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} + 2>/dev/null || true
          
          # ä¸‹è½½å¹¶è§£å‹æ–°ç‰ˆæœ¬
          echo "ä¸‹è½½worker.zip..."
          wget -q --show-progress -O worker.zip "$TARGET_DOWNLOAD"
          
          if [ ! -f worker.zip ]; then
            echo "é”™è¯¯: ä¸‹è½½å¤±è´¥"
            exit 1
          fi
          
          echo "è§£å‹æ–‡ä»¶..."
          unzip -q -o worker.zip
          rm -f worker.zip
          
          # æ›´æ–°ç‰ˆæœ¬è®°å½•
          echo "$TARGET_TAG" > version.txt
          
          echo "âœ… æ›´æ–°å®Œæˆ: $LOCAL_VERSION -> $TARGET_TAG"

      - name: æäº¤æ›´æ–°
        if: env.UPDATE_NEEDED == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            ğŸ”„ è‡ªåŠ¨æ›´æ–° Worker
            ç‰ˆæœ¬: ${{ env.TARGET_TAG }}
            ç±»å‹: ${{ env.UPDATE_REASON == 'manual_latest' && 'æ‰‹åŠ¨Latest' : (env.UPDATE_REASON == 'newer_latest' && 'è‡ªåŠ¨Latest' : 'è‡ªåŠ¨Pre-release') }}
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

      - name: æ— éœ€æ›´æ–°æç¤º
        if: env.UPDATE_NEEDED != 'true'
        run: |
          echo "âœ… å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
          echo "æœ¬åœ°ç‰ˆæœ¬: $LOCAL_VERSION"
          echo "æœ€æ–°æ­£å¼ç‰ˆ: $LATEST_TAG"
          echo "æœ€æ–°Pre-release: $PRE_TAG"

name: Auto Update Worker

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *" # æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      update_latest:
        description: 'æ˜¯å¦æ‰‹åŠ¨æ›´æ–° Latest æ­£å¼ç‰ˆï¼Ÿ'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: åˆå§‹åŒ–ä»“åº“
        uses: actions/checkout@v4

      - name: è·å–å½“å‰æœ¬åœ°ç‰ˆæœ¬
        id: get_local_version
        run: |
          if [ -f version.txt ]; then
            LOCAL_VERSION=$(cat version.txt)
          else
            LOCAL_VERSION="v0.0.0"
          fi
          echo "LOCAL_VERSION=$LOCAL_VERSION" >> $GITHUB_ENV

      - name: è·å–æ‰€æœ‰å‘å¸ƒç‰ˆæœ¬ä¿¡æ¯
        id: get_releases
        run: |
          API_URL="https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases"
          RESPONSE=$(curl -s "$API_URL")
          
          # è·å–æœ€æ–°æ­£å¼ç‰ˆ
          LATEST_RELEASE=$(echo "$RESPONSE" | jq -r '[.[] | select(.prerelease==false)][0]')
          LATEST_TAG=$(echo "$LATEST_RELEASE" | jq -r '.tag_name // ""')
          LATEST_DOWNLOAD=$(echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name=="worker.zip") | .browser_download_url // ""')
          
          # è·å–æœ€æ–°Pre-release
          PRE_RELEASE=$(echo "$RESPONSE" | jq -r '[.[] | select(.prerelease==true)][0]')
          PRE_TAG=$(echo "$PRE_RELEASE" | jq -r '.tag_name // ""')
          PRE_DOWNLOAD=$(echo "$PRE_RELEASE" | jq -r '.assets[] | select(.name=="worker.zip") | .browser_download_url // ""')
          
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "LATEST_DOWNLOAD=$LATEST_DOWNLOAD" >> $GITHUB_ENV
          echo "PRE_TAG=$PRE_TAG" >> $GITHUB_ENV
          echo "PRE_DOWNLOAD=$PRE_DOWNLOAD" >> $GITHUB_ENV
          
          echo "å½“å‰æœ¬åœ°ç‰ˆæœ¬: $LOCAL_VERSION"
          echo "æœ€æ–°æ­£å¼ç‰ˆ: $LATEST_TAG"
          echo "æœ€æ–°Pre-release: $PRE_TAG"

      - name: ç‰ˆæœ¬æ¯”è¾ƒå’Œé€‰æ‹©æ›´æ–°ç›®æ ‡
        id: select_target
        run: |
          # å‡½æ•°ï¼šæ¯”è¾ƒç‰ˆæœ¬å· (è¿”å›: 0=ç›¸ç­‰, 1=ç‰ˆæœ¬1>ç‰ˆæœ¬2, 2=ç‰ˆæœ¬1<ç‰ˆæœ¬2)
          compare_versions() {
            if [ "$1" = "$2" ]; then
              return 0
            fi
            
            # æå–çº¯æ•°å­—ç‰ˆæœ¬å·è¿›è¡Œæ¯”è¾ƒ
            v1=$(echo "$1" | sed 's/^v//' | sed 's/-.*//')
            v2=$(echo "$2" | sed 's/^v//' | sed 's/-.*//')
            
            IFS='.' read -r -a v1_parts <<< "$v1"
            IFS='.' read -r -a v2_parts <<< "$v2"
            
            for i in {0..2}; do
              num1=${v1_parts[i]:=0}
              num2=${v2_parts[i]:=0}
              
              if [ "$num1" -gt "$num2" ]; then
                return 1
              elif [ "$num1" -lt "$num2" ]; then
                return 2
              fi
            done
            
            # å¦‚æœæ•°å­—éƒ¨åˆ†ç›¸åŒï¼Œæ¯”è¾ƒå®Œæ•´å­—ç¬¦ä¸²
            if [[ "$1" > "$2" ]]; then
              return 1
            else
              return 2
            fi
          }
          
          # ç¡®å®šè¦æ›´æ–°çš„ç›®æ ‡ç‰ˆæœ¬
          TARGET_TAG=""
          TARGET_DOWNLOAD=""
          UPDATE_REASON=""
          
          # æ‰‹åŠ¨æ›´æ–°Latestçš„æƒ…å†µ
          if [ "${{ github.event.inputs.update_latest == 'true' }}" = "true" ] && [ -n "$LATEST_TAG" ]; then
            TARGET_TAG="$LATEST_TAG"
            TARGET_DOWNLOAD="$LATEST_DOWNLOAD"
            UPDATE_REASON="manual_latest"
            echo "æ‰‹åŠ¨é€‰æ‹©æ›´æ–°åˆ° Latest: $LATEST_TAG"
          
          # è‡ªåŠ¨æ›´æ–°é€»è¾‘
          else
            # æ¯”è¾ƒæœ¬åœ°ç‰ˆæœ¬ä¸æœ€æ–°æ­£å¼ç‰ˆ
            compare_versions "$LOCAL_VERSION" "$LATEST_TAG"
            local_vs_latest=$?
            
            # æ¯”è¾ƒæœ¬åœ°ç‰ˆæœ¬ä¸æœ€æ–°Pre-release
            compare_versions "$LOCAL_VERSION" "$PRE_TAG"
            local_vs_pre=$?
            
            # é€‰æ‹©æ›´æ–°çš„ç›®æ ‡
            if [ -n "$LATEST_TAG" ] && [ $local_vs_latest -eq 2 ]; then
              # æœ¬åœ°ç‰ˆæœ¬è½åäºæœ€æ–°æ­£å¼ç‰ˆ
              TARGET_TAG="$LATEST_TAG"
              TARGET_DOWNLOAD="$LATEST_DOWNLOAD"
              UPDATE_REASON="newer_latest"
              echo "å‘ç°æ›´æ–°çš„æ­£å¼ç‰ˆ: $LATEST_TAG"
            elif [ -n "$PRE_TAG" ] && [ $local_vs_pre -eq 2 ]; then
              # æœ¬åœ°ç‰ˆæœ¬è½åäºæœ€æ–°Pre-release
              TARGET_TAG="$PRE_TAG"
              TARGET_DOWNLOAD="$PRE_DOWNLOAD"
              UPDATE_REASON="newer_pre"
              echo "å‘ç°æ›´æ–°çš„Pre-release: $PRE_TAG"
            else
              echo "å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
            fi
          fi
          
          echo "TARGET_TAG=$TARGET_TAG" >> $GITHUB_ENV
          echo "TARGET_DOWNLOAD=$TARGET_DOWNLOAD" >> $GITHUB_ENV
          echo "UPDATE_REASON=$UPDATE_REASON" >> $GITHUB_ENV

      - name: æ‰§è¡Œæ›´æ–°
        if: env.TARGET_TAG != ''
        run: |
          echo "å¼€å§‹æ›´æ–°åˆ°ç‰ˆæœ¬: $TARGET_TAG"
          echo "ä¸‹è½½é“¾æ¥: $TARGET_DOWNLOAD"
          
          # æ¸…ç†å½“å‰ç›®å½•ï¼ˆä¿ç•™.gitï¼‰
          shopt -s extglob
          rm -rf !(.git)
          
          # ä¸‹è½½å¹¶è§£å‹æ–°ç‰ˆæœ¬
          wget -O worker.zip "$TARGET_DOWNLOAD"
          unzip -o worker.zip
          rm worker.zip
          
          # æ›´æ–°ç‰ˆæœ¬è®°å½•
          echo "$TARGET_TAG" > version.txt
          
          echo "æ›´æ–°å®Œæˆ: $LOCAL_VERSION -> $TARGET_TAG"

      - name: æäº¤æ›´æ–°
        if: env.TARGET_TAG != ''
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            ${{ env.UPDATE_REASON == 'manual_latest' && format('ğŸ”„ æ‰‹åŠ¨æ›´æ–° Latest Workerï¼š{0}', env.TARGET_TAG) || '' }}
            ${{ env.UPDATE_REASON == 'newer_latest' && format('ğŸ”„ è‡ªåŠ¨æ›´æ–° Latest Workerï¼š{0}', env.TARGET_TAG) || '' }}
            ${{ env.UPDATE_REASON == 'newer_pre' && format('ğŸ”„ è‡ªåŠ¨æ›´æ–° Pre-release Workerï¼š{0}', env.TARGET_TAG) || '' }}
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          push_options: --force

      - name: æ— éœ€æ›´æ–°æç¤º
        if: env.TARGET_TAG == ''
        run: |
          echo "âœ… å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
          echo "æœ¬åœ°ç‰ˆæœ¬: $LOCAL_VERSION"
          echo "æœ€æ–°æ­£å¼ç‰ˆ: $LATEST_TAG"
          echo "æœ€æ–°Pre-release: $PRE_TAG"
